<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico">
    <title>网页历史延时截图</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/lcard.css"></head>
<body>
    <div id="navigation">
        <div class="widthlimit">
        <a href="/"><img src="/assets/images/LC.gif" height="64px"></a>
        <ul><li>
                    <a href="/">主页</a>
                </li><li>
                    <a href="/blogs">博客</a>
                </li><li>
                    <a href="/archive">存储库</a>
                </li><li>
                    <a href="/notes">课程记录</a>
                </li><li>
                    <a href="/about">关于</a>
                </li></ul>
        </div>
    </div>

    
<h1>网页历史延时截图</h1>

<h2>PGFPlotsEdt 结尾的版本截图视频自动化制作方法。</h2>

<h2>2025-02-23</h2>

<div id="main" class="widthlimit">

    <a href="https://cloud.tencent.com/act/cps/redirect?redirect=6150&cps_key=3b86b83ec1516f560c5dc351fe35065b&from=console"><img src="/assets/images/rhino-design-1200x90x2.png" alt="【腾讯云】2核2G云服务器新老同享 99元/年，续费同价，云服务器3年机/5年机限时抢购，低至 2.5折" style="max-width:100%;cursor:pointer;"></img></a>


    <p>在 <a href="/archive/works/0208/">PGFPlotsEdt 视频</a> 的 <a href="https://www.bilibili.com/video/BV1f5ebeREet/?share_source=copy_web&amp;vd_source=39488c6d502ff5f5bcbe7d9e77acfea8&amp;t=120">结尾</a> 处通过一个延时影像序列展示了 <a href="/archive/works/0203/">PGFPlotsEdt</a> 四年来的前端变迁，该段序列大概包含了 400 张图像（双语版本总共 800 张图像），如果一个一个版本去截图，不仅效率很慢，而且可能会导致截图区域前后不一致。此处展示了这段序列是如何通过自动化方法生成的。</p>
<h3>包配置</h3>
<p>首先安装 <a href="https://nodejs.org/en/download">Node.js</a>，然后在项目文件夹中写入下面的 <code>package.json</code> 配置文件：</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"git-screenshot-webpage"</span><span class="token punctuation">,</span><br>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span><br>  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Get the screenshot sequence of a git repository."</span><span class="token punctuation">,</span><br>  <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"screenshot.js"</span><span class="token punctuation">,</span><br>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"node screenshot.js"</span><span class="token punctuation">,</span><br>    <span class="token property">"git-txt"</span><span class="token operator">:</span> <span class="token string">"node git-history.js"</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"Log Creative"</span><span class="token punctuation">,</span><br>  <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"MIT"</span><span class="token punctuation">,</span><br>  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"live-server"</span><span class="token operator">:</span> <span class="token string">"^1.2.2"</span><span class="token punctuation">,</span><br>    <span class="token property">"puppeteer"</span><span class="token operator">:</span> <span class="token string">"^22.12.1"</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>然后通过 <code>npm install</code> 安装 <code>live-sever</code> 和 <code>puppeteer</code> 包：</p>
<ul>
<li><a href="https://github.com/tapio/live-server"><code>live-server</code></a> 用来为前端项目建立开发服务器，能够通过检测文件变化自动更新前端页面，非常适合本文需要文件更新的场景。</li>
<li><a href="https://github.com/puppeteer/puppeteer">puppeteer</a> 提供浏览器的高层次 API，其中包含了对网页截图导出的 API，也被用于自动化测试及 Mermaid 图导出。</li>
</ul>
<p>接着在该项目文件夹下克隆项目存储库备用，比如本文中的 <code>PGFPlotsEdt</code>，注意不能是从 Download ZIP 下载的文件夹，必须要包含 git 记录。</p>
<h3>截图导出</h3>
<p>建立下面的 <code>screenshot.js</code>，运行后主要进行下面的操作：</p>
<ul>
<li>启动 <code>live-server</code>，其他线程/进程可以通过 <code>http://127.0.0.1:5500/</code> 访问当前项目存储库的前端网页（默认根网页产生于 <code>index.html</code>）。</li>
<li>启动 <code>puppeteer</code> 浏览器，建立合适的视口尺寸（此处 1280x720）。</li>
<li>通过 git 命令行，签出最新版本后，对每个版本从后向前遍历：
<ul>
<li>进行版本号更新操作（如有）；</li>
<li>计算到此为止的提交数目；</li>
<li>通过 <code>puppeteer</code> 打开网页，并等待网络资源加载完毕，此处还添加了额外的等待时间保证网页已经稳定不再变化；</li>
<li>截图并存储到文件，文件名后缀为按照补全前置零的提交数目，以下划线（<code>_</code>）分隔主序列名和图像编号，用于后续导入到 After Effects。</li>
</ul>
</li>
<li>关闭 <code>live-server</code> 和 <code>puppeteer</code> 实例。</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token punctuation">{</span> execSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> liveServer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'live-server'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'console'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// Your screenshot folder to save.</span><br><span class="token keyword">const</span> screenFolder <span class="token operator">=</span> <span class="token string">'screenshots'</span><span class="token punctuation">;</span><br><span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>screenFolder<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    fs<span class="token punctuation">.</span><span class="token function">rmSync</span><span class="token punctuation">(</span>screenFolder<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">recursive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">force</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>screenFolder<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// The port of live-server.</span><br><span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">5500</span><br><br><span class="token comment">// Start the live-server first</span><br>liveServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    <span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token string">'PGFPlotsEdt'</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">open</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">logLevel</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token constant">PORT</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setViewport</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">1280</span><span class="token punctuation">,</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">720</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">let</span> version <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span><br>    <span class="token keyword">let</span> filename<span class="token punctuation">;</span><br><br>    <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git checkout master'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">cwd</span><span class="token operator">:</span> <span class="token string">'PGFPlotsEdt'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">while</span><span class="token punctuation">(</span>version <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <br>        <span class="token keyword">try</span><span class="token punctuation">{</span> <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'python version_updater.py'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">cwd</span><span class="token operator">:</span> <span class="token string">'PGFPlotsEdt/res'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br>        version <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">"git rev-list HEAD --count"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">cwd</span><span class="token operator">:</span> <span class="token string">'PGFPlotsEdt'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        filename <span class="token operator">=</span> <span class="token string">"pgfplotsedt_"</span> <span class="token operator">+</span> version<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://127.0.0.1:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">waitUntil</span><span class="token operator">:</span> <span class="token string">'networkidle2'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">await</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wait for 1 seconds to ensure the server is up and running</span><br>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">screenshot</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>screenFolder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git checkout HEAD^'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">cwd</span><span class="token operator">:</span> <span class="token string">'PGFPlotsEdt'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    liveServer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Shutdown live-server after taking the screenshot</span><br><span class="token punctuation">}</span><br><br><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>之后在命令行中通过 <code>npm run start</code> 运行该脚本。</p>
<h3>历史信息导出</h3>
<p>历史信息通过建立下面的 <code>git-history.js</code> 文件实现，实际上也可以通过命令行脚本，此处统一起见皆写为 JavaScript 脚本。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> execSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// The commit details</span><br>result <span class="token operator">=</span> <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git log --oneline --reverse'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">cwd</span><span class="token operator">:</span> <span class="token string">'PGFPlotsEdt'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'git-history.txt'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// the time of every commit</span><br>result <span class="token operator">=</span> <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git log --pretty=format:"%ad" --date=short --reverse'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">cwd</span><span class="token operator">:</span> <span class="token string">'PGFPlotsEdt'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'git-time.txt'</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>之后在命令行中通过 <code>npm run git-txt</code> 运行该脚本。</p>
<h3>导入 After Effects</h3>
<p>After Effects 可以通过 <a href="https://helpx.adobe.com/cn/after-effects/using/expression-language-reference.html">JavaScript API</a> 来程式化地合成动画，此处使用了下面的步骤：</p>
<ul>
<li>将 <code>screenshot/</code> 文件夹中的图像序列导入；生成的历史文件 <code>git-history.txt</code> 和 <code>git-time.txt</code> 也导入项目。</li>
<li>从图像序列新建合成。</li>
<li>在画面左下角建立版本号文字对象，对“源文本”建立下面的表达式：</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token string">"v"</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">timeToFrames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span></code></pre>
<ul>
<li>在画面右下角建立版本日期文字对象，对“源文本”建立下面的表达式：</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">footage</span><span class="token punctuation">(</span><span class="token string">"git-time.txt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sourceText<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token function">timeToFrames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
<ul>
<li>在画面右下角继续建立版本提交描述文字对象，对“源文本”建立下面的表达式：</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">footage</span><span class="token punctuation">(</span><span class="token string">"git-history.txt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sourceText<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token function">timeToFrames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
<p>之后可以通过动态链接功能将 After Effects 合成导入 Premiere Pro 项目中。注意如果 Premiere Pro 没有正确显示文字内容，可以通过同时打开 After Effects 项目来解决这个问题。</p>

</div>

    <footer>
        <div class="widthlimit">
            <p>版权所有 © Log Creative 2012-2024，保留所有权利。</p>
            <p>除有开源协议声明的，未经许可，不可用于商业用途。</p>
            <p>Powered by <a href="https://www.11ty.dev/" target="_blank">Eleventy</a>&nbsp;|&nbsp;<a href="https://beian.miit.gov.cn" target="_blank">沪ICP备2021032524号</a></p>
        </div>
    </footer>
</body>
</html>